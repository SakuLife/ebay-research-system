name: eBay Auto Research Pipeline (Pattern②)

on:
  repository_dispatch:
    types: [auto_research_request]
  workflow_dispatch:

jobs:
  auto_research:
    runs-on: self-hosted
    timeout-minutes: 360  # 6時間

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pip3 install -r requirements.txt

      - name: Wait for apt lock release
        run: |
          for i in $(seq 1 30); do
            if ! flock -n /var/lib/apt/lists/lock true 2>/dev/null; then
              echo "apt lock held, waiting... ($i/30)"
              sleep 10
            else
              echo "apt lock free"
              break
            fi
          done

      - name: Install Playwright browsers (if needed)
        run: |
          python3 -m playwright install --with-deps chromium

      - name: Run auto research pipeline
        env:
          # Windows encoding fix
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
          # eBay API
          EBAY_CLIENT_ID: ${{ secrets.EBAY_CLIENT_ID }}
          EBAY_CLIENT_SECRET: ${{ secrets.EBAY_CLIENT_SECRET }}
          EBAY_REFRESH_TOKEN: ${{ secrets.EBAY_REFRESH_TOKEN }}
          EBAY_USE_SANDBOX: ${{ secrets.EBAY_USE_SANDBOX }}
          # Production App ID for Finding API (required for real sold data)
          EBAY_PRODUCTION_APP_ID: ${{ secrets.EBAY_PRODUCTION_APP_ID }}

          # 楽天 API
          RAKUTEN_APPLICATION_ID: ${{ secrets.RAKUTEN_APPLICATION_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}

          # Amazon PA-API
          AMAZON_ACCESS_KEY_ID: ${{ secrets.AMAZON_ACCESS_KEY_ID }}
          AMAZON_SECRET_ACCESS_KEY: ${{ secrets.AMAZON_SECRET_ACCESS_KEY }}
          AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
          AMAZON_MARKETPLACE: JP

          # Google Sheets
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          SHEETS_SPREADSHEET_ID: ${{ secrets.SHEETS_SPREADSHEET_ID }}
          SHEETS_NAME_INPUT: 入力シート
          SHEETS_NAME_FIND: 検索ベース

          # Gemini API
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.5-flash

          # SerpAPI (Google Lens / Google Shopping / eBay Sold)
          SERP_API_KEY: ${{ secrets.SERP_API_KEY }}

          # Mock settings
          USE_MOCKS: ${{ secrets.USE_MOCKS }}
        run: |
          mkdir -p logs
          LOG_FILE="logs/$(date +'%Y-%m-%d_%H%M').txt"
          echo "Log file: $LOG_FILE"
          python3 -m src.auto_research_runner 2>&1 | tee "$LOG_FILE"

      - name: Upload pipeline logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: logs/
          retention-days: 3
