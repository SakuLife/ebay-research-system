# 仕様書 v1.0（Codex実装向け / APIベース完全自動＋手動承認出品）

## 0. プロジェクト概要

### プロジェクト名

`ebay-auto-sourcing-and-listing`

### 目的（1文）

eBay向けに「売れ筋候補抽出  国内仕入れ候補探索  利益判定  手動承認  英語生成  eBay出品」までを自動化し、GitHub Actionsで定期運用する。

### 基本方針

- Terapeakは使わない（APIベース）
- 候補抽出〜利益判定は自動、最終出品可否はスプレッドシートで人が承認
- 承認済みのみ、Gemini生成→eBay出品まで自動
- 設定（ホットワード/カテゴリなど）は別ファイル化し、差し替えで運用

---

## 1. 前提（売れ筋判定の現実）

- 「売れ筋っぽい」判定は可能。ただしTerapeak同等の精度保証はしない
- Completed/Sold検索のヒット件数や価格帯分布を指標化して候補を拾う

---

## 2. 国（UK/US/EU）切替の違い

- 市場（買い手層）：売れるカテゴリや価格帯が変わる
- 通貨：USD/GBP/EURで価格戦略が変わる
- 送料と配送サービス：国ごとにコスト感が変わる
- 規制：香水/化粧品/電池などは国別に制限されやすい
- 税（VAT等）：EU/UKで影響が出ることがある
- 検索結果の見え方：同じキーワードでも変わることがある

仕様としては「UK固定」ではなく設定で切替できることを必須とする。

---

## 3. スコープ

### やること

- eBay公式APIで「売れ筋候補」を抽出（定義は後述）
- 国内仕入れ先を検索し、仕入れ価格とURLを収集（大手優先）
- 利益計算結果をGoogle Sheetsに出力
- `status=APPROVED` 行のみGemini生成→eBay出品APIまで実行（公開まで）
- GitHub Actionsで毎朝自動実行
- Discord通知（成功/失敗/承認待ち件数）

### やらないこと（v1）

- Terapeakの完全再現
- 国内ECの全サイト対応（まずは在庫が枯れにくい大手のみ）
- 画像の自動生成（まずは既存画像URL指定 or 手動添付）
- 危険物/規制対象の完全自動判定（ルールで弾く）

---

## 4. 全体アーキテクチャ

### 実行基盤

- GitHub Actions（スケジュール実行 + 手動実行）
- Python（メイン処理）
- Google Sheets API（入出力）
- eBay API（検索/出品）
- Gemini API（英語生成/サイズ重量推定）
- 通知：Discord Webhook

### リポジトリ構成（案）

```
/config
  hotwords.yaml
  categories.yaml
  marketplaces.yaml
  sourcing_sites.yaml
  fee_rules.yaml
  prompt_listing.txt
/src
  main.py
  ebay_client.py
  sheets_client.py
  sourcing.py
  profit.py
  gpt_listing.py
  notifier.py
  validators.py
/tests
  ...
/.github/workflows
  daily.yml
.env.example
README.md
```

---

## 5. 設定ファイル仕様

### 5.1 hotwords.yaml

- 売れ筋探索に使うキーワード群

```yaml
keywords:
  - "TOKIO INKARAMI"
  - "Shiseido"
  - "Pilot frixion"
```

### 5.2 marketplaces.yaml

```yaml
default_market: "UK"
markets:
  UK: { currency: "GBP", site: "EBAY_GB" }
  US: { currency: "USD", site: "EBAY_US" }
  EU: { currency: "EUR", site: "EBAY_DE" }
```

### 5.3 categories.yaml

- v1は「カテゴリは人が入れる」でもOK（自動化は後回し）

```yaml
default_category_id: null
blocked_categories:
  - "Perfume (hazmat?)"
```

### 5.4 sourcing_sites.yaml（国内仕入れ先）

- v1：楽天/Amazonを優先、メルカリ除外（中古混在のため）

```yaml
sites:
  - name: "Rakuten"
    enabled: true
  - name: "AmazonJP"
    enabled: true
  - name: "Mercari"
    enabled: false
```

---

## 6. Google Sheets 仕様

### 6.1 シート構成

- `Candidates`：自動追加される候補（レビュー待ち）
- `Approved`：承認されたもの（出品対象）
- `Listed`：出品済み（結果ログ）
- `Config`：必要なら手動設定（為替/手数料等）

実装は1シート運用でも可。運用しやすさ優先で分け推奨。

### 6.2 行の主要カラム（例）

- 共通識別
  - `candidate_id`（UUID）
  - `created_at`
  - `market`（UK/US/EU）
  - `status`（NEW/REVIEW/APPROVED/REJECTED/LISTED）

- eBay側情報
  - `keyword`
  - `ebay_search_query`
  - `ebay_item_url`
  - `ebay_price`
  - `ebay_shipping`
  - `ebay_currency`
  - `ebay_category_id`（手動でもOK）
  - `ebay_sold_signal`（APIベースの売れ筋スコア）

- 仕入れ側情報
  - `source_site`
  - `source_url`
  - `source_price_jpy`
  - `source_shipping_jpy`（取れれば）
  - `stock_hint`（在庫あり/不明）

- 利益計算
  - `fx_rate`
  - `estimated_weight_kg`
  - `estimated_pkg_cm`（例：L/W/H）
  - `profit_jpy_no_rebate`
  - `profit_margin_no_rebate`
  - `profit_jpy_with_rebate`
  - `profit_margin_with_rebate`
  - `is_profitable`（profit>=1）

- Gemini生成（承認後）
  - `title_en`
  - `description_en`
  - `size_weight_block`（4行形式）
  - `gpt_model`
  - `gpt_prompt_version`

- 出品結果
  - `listing_id`
  - `listed_url`
  - `listed_at`
  - `error_message`

---

## 7. 売れ筋候補抽出ロジック（Terapeak代替）

### 入力

- hotwords.yaml の keywords
- 市場（UK/US/EU）
- 期間（例：直近30日/90日：設定化）

### 出力

- 候補Listingの集合（URL/価格など）

### スコア（v1案）

- `sold_signal` を0〜100で算出
- completed/sold検索でヒット数が多いほど加点
- 価格帯が中央値に近いほど加点
- 同一っぽい商品（型番/ブランド）に集約して加点（簡易）

完全精度より「候補を拾う」こと優先。

---

## 8. 国内仕入れ検索仕様（大手中心）

### 入力

- eBay商品名（整形済み）
- ブランド/型番が取れる場合は優先

### ルール

- 検索クエリを整形（不要語除去/型番優先）
- 対象は Rakuten / AmazonJP（在庫が枯れにくい）
- 価格は「送料込み（取れる範囲）」を優先
- 中古混在が濃いサイト（メルカリ等）はv1で除外

### 出力

- 最安候補URL + 価格（JPY）

---

## 9. 利益判定

### 入力

- 仕入れ値（JPY）
- eBay売値/送料（現地通貨）
- 為替
- eBay手数料ルール（簡易でOK、のち拡張）
- 実重量（Gemini推定）

### 判定

- `profit_jpy_no_rebate >= 1` なら `is_profitable=true`
- trueのみ `Candidates` に追記（または全件入れてフラグでもOK）

---

## 10. 手動承認・自動出品

### 承認

- ユーザーが `status=APPROVED` に変更（スプシ）

### 出品トリガー

- 定期実行時に `status=APPROVED` かつ `listing_id` 空の行を処理

### Gemini生成

- 入力：商品名/型番/カテゴリ/容量/セット内容 等（取れる範囲）
- 出力：英語タイトル/英語概要/サイズ重量（4行）

### 出品API

- eBay Inventory / Listing API を利用
- v1は「公開（Publish）まで」実行

---

## 11. 禁止・制限（香水/コスメ等）

- 香水/化粧品/アルコール/電池などは国/配送で制限されやすい
- v1では `categories.yaml` / `blocked_keywords` で自動除外できる仕組みを用意
- 自動出品は「落ちる可能性がある」前提で、失敗時はREVIEWへ戻す運用

---

## 12. 自動実行（GitHub Actions）

### スケジュール

- 毎朝 07:00 JST（設定可）

### ジョブ

1. 候補抽出 → Candidates追記
2. APPROVED行の処理 → Gemini生成 → Publish → Listed更新
3. 失敗件数サマリを通知（Discord）

### 秘密情報

- GitHub Secretsで管理
  - EBAY_CLIENT_ID / EBAY_CLIENT_SECRET / REFRESH_TOKEN
  - GOOGLE_SERVICE_ACCOUNT_JSON
  - GEMINI_API_KEY
  - DISCORD_WEBHOOK_URL
  - RAKUTEN_APPLICATION_ID
  - AMAZON_ACCESS_KEY_ID / AMAZON_SECRET_ACCESS_KEY / AMAZON_PARTNER_TAG

---

## 13. 受け入れ基準（DoD）

- hotwords.yamlの1キーワードから候補がスプシに追加される
- `profit>=1` 判定がスプシに反映される
- `status=APPROVED` の行がGemini生成され、出品（Publish）まで到達する
- 失敗時に `error_message` が残り、通知が飛ぶ
- 設定ファイルを編集するだけで市場/キーワード/サイトの切替ができる

---

## 14. 入出力例（成功2/失敗2）

### 成功例1（候補抽出Candidates）

- input: keyword="TOKIO INKARAMI", market="UK"
- output: Candidatesに3件追加、profit>=1が1件 true

### 成功例2（APPROVED出品）

- input: status=APPROVEDの1行
- output: title/description/sizeweight生成、Publish、Listedに記録

### 失敗例1（仕入れ検索失敗）

- output: source_url空、status=REVIEW、error_message="No supplier found"

### 失敗例2（出品API拒否）

- output: status=REVIEW、error_message="Listing blocked/restricted category"
